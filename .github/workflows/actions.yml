name: Build and Deploy to GKE

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ develop ]

jobs:
  setup-build-publish-deploy:
    name: Build and Push Docker
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    # Configure Docker login
    - run: |-
        docker login -u ${DOCKER_USER } -p ${DOCKER_PASSWORD }
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USER }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}  

    # Build the Docker image
    - name: Build
      run: |-
        docker build -t "asingh01/test-images:webserver" .

    # Push the Docker image to Google Container Registry
    - name: Publish
      run: |-
        docker push "asingh01/test-images:webserver"

    - name: Terraform Setup
      run: |-
        curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add - \
        && apt install software-properties-common -y \
        && apt-add-repository "deb [arch=$(dpkg --print-architecture)] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
        && apt update \
        && apt install terraform=0.13.5
